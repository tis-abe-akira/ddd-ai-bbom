# å®Ÿè£…æ¨™æº–ãƒ»ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ã‚·ãƒ³ã‚¸ã‚±ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹å®Ÿè£…æ¨™æº–ã¨ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã‚’å®šç¾©ã—ã¾ã™ã€‚

## ğŸ¯ ç›®çš„
- Bounded Contexté–“ã®å®Ÿè£…ä¸€è²«æ€§ã‚’ä¿ã¤
- ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åŠ¹ç‡åŒ–
- æ–°ã—ã„Bounded Contextä½œæˆæ™‚ã®æ¨™æº–åŒ–
- é–‹ç™ºãƒãƒ¼ãƒ ã®ç”Ÿç”£æ€§å‘ä¸Š

## ğŸ“‹ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å®Ÿè£…æ¨™æº–

### å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

**ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å«ã‚ã‚‹ï¼š**
```java
@Column(name = "created_at", nullable = false, updatable = false)
private LocalDateTime createdAt;

@Column(name = "updated_at", nullable = false)
private LocalDateTime updatedAt;

@PrePersist
protected void onCreate() {
    this.createdAt = LocalDateTime.now();
    this.updatedAt = LocalDateTime.now();
}

@PreUpdate
protected void onUpdate() {
    this.updatedAt = LocalDateTime.now();
}
```

**é›†ç´„ãƒ«ãƒ¼ãƒˆï¼ˆAggregate Rootï¼‰ã«ã¯æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ç”¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ï¼š**
```java
@Version
@Column(name = "version")
private Long version;

// getter/setterã‚‚å¿…è¦
public Long getVersion() {
    return version;
}

public void setVersion(Long version) {
    this.version = version;
}
```

### æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡å®Ÿè£…æ¨™æº–

**Updateæ“ä½œå°‚ç”¨DTOã®ä½œæˆï¼š**
```java
public class UpdateEntityRequest {
    // ...åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰...
    private Long version; // å¿…é ˆï¼šæ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ç”¨
    
    // getter/setter
    public Long getVersion() { return version; }
    public void setVersion(Long version) { this.version = version; }
}
```

**Serviceå±¤ã§ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ï¼š**
```java
@Transactional
public Entity updateEntity(Long id, UpdateEntityRequest request) {
    Optional<Entity> existingEntity = entityRepository.findById(id);
    if (existingEntity.isEmpty()) {
        throw new ResourceNotFoundException("Entity not found with id: " + id);
    }

    Entity entity = existingEntity.get();
    
    // Spring Data JPAãŒè‡ªå‹•çš„ã«æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã ã‘ã§ã€Spring Data JPAãŒè‡ªå‹•çš„ã«OptimisticLockingFailureExceptionã‚’æŠ•ã’ã‚‹
    entity.setVersion(request.getVersion());

    // ...ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°...
    
    return entityRepository.save(entity);
}
```

**Controllerå±¤ã®æ›´æ–°ï¼š**
```java
@PutMapping("/{id}")
public ResponseEntity<Entity> updateEntity(@PathVariable Long id, @RequestBody UpdateEntityRequest request) {
    Entity updatedEntity = entityService.updateEntity(id, request);
    return ResponseEntity.ok(updatedEntity);
}
```

### ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¨­è¨ˆåŸå‰‡
- `@Entity` + `@Table` ã§ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’æ˜ç¤º
- ãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼ã¯ `@Id` + `@GeneratedValue`
- å¤–éƒ¨ã‚­ãƒ¼ã¯é©åˆ‡ãª `@JoinColumn` ã§è¨­å®š
- Lazy loading ã‚’æ„è­˜ã—ãŸé–¢é€£è¨­å®š

## ğŸ› ï¸ Serviceå±¤å®Ÿè£…æ¨™æº–

### ãƒ¡ã‚½ãƒƒãƒ‰å‘½åè¦å‰‡
```java
// CRUDæ“ä½œ
public Entity createEntity(CreateEntityRequest request)
public Page<Entity> getAllEntities(Pageable pageable)  // ãƒšãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œå¿…é ˆ
public Entity getEntityById(Long id)
public Entity updateEntity(Long id, UpdateEntityRequest request)
public void deleteEntity(Long id)
```

### ä¾‹å¤–å‡¦ç†æ¨™æº–
```java
// ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
public Entity getEntityById(Long id) {
    return repository.findById(id)
        .orElseThrow(() -> new ResourceNotFoundException("Entity not found with id: " + id));
}

// ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«é•åã®å ´åˆ
public Entity validateBusinessRules(Entity entity) {
    if (violatesBusinessRule(entity)) {
        throw new BusinessRuleViolationException("Business rule violation: " + details);
    }
    return entity;
}

// å‰Šé™¤æ™‚ã¯å­˜åœ¨ãƒã‚§ãƒƒã‚¯
public void deleteEntity(Long id) {
    if (!repository.existsById(id)) {
        throw new ResourceNotFoundException("Entity not found with id: " + id);
    }
    repository.deleteById(id);
}
```

**ä¾‹å¤–ä½¿ã„åˆ†ã‘ã®æŒ‡é‡ï¼š**
- `ResourceNotFoundException`: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒå­˜åœ¨ã—ãªã„ã€å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„
- `BusinessRuleViolationException`: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—ã€æ¥­å‹™åˆ¶ç´„é•åã€çŠ¶æ…‹ä¸æ•´åˆ

### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
```java
@Transactional  // ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤æ“ä½œã«ã¯å¿…é ˆ
public Entity createEntity(CreateEntityRequest request) {
    // å®Ÿè£…
}

// èª­ã¿å–ã‚Šå°‚ç”¨æ“ä½œã«ã¯readOnlyã‚’æŒ‡å®š
@Transactional(readOnly = true)
public Entity getEntityById(Long id) {
    // å®Ÿè£…
}
```

## ğŸŒ Controllerå±¤å®Ÿè£…æ¨™æº–

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­è¨ˆ
```java
@RestController
@RequestMapping("/api/v1/entities")  // ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å¿…é ˆ
public class EntityController {
    
    @PostMapping
    public ResponseEntity<Entity> createEntity(@RequestBody CreateEntityRequest request)
    
    @GetMapping
    public ResponseEntity<Page<Entity>> getAllEntities(Pageable pageable)
    
    @GetMapping("/{id}")
    public ResponseEntity<Entity> getEntityById(@PathVariable Long id)
    
    @PutMapping("/{id}")
    public ResponseEntity<Entity> updateEntity(@PathVariable Long id, @RequestBody UpdateEntityRequest request)
    
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteEntity(@PathVariable Long id)
}
```

### ä¾‹å¤–å‡¦ç†æ–¹é‡
- **Controllerå±¤ã§ã¯ try-catch ã‚’è¨˜è¿°ã—ãªã„**
- `GlobalExceptionHandler` ã«ä¾‹å¤–å‡¦ç†ã‚’å§”è­²
- Serviceå±¤ã‹ã‚‰é©åˆ‡ãªä¾‹å¤–ã‚’æŠ•ã’ã‚‹ï¼š
  - **`ResourceNotFoundException`**: ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼ˆHTTP 404ï¼‰
  - **`BusinessRuleViolationException`**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯é•åã®å ´åˆï¼ˆHTTP 400ï¼‰
  - ä¸¡æ–¹ã¨ã‚‚ `com.example.syndicatelending.common.application.exception` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã‚‰ä½¿ç”¨

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼
```java
// æˆåŠŸæ™‚
return ResponseEntity.ok(entity);           // 200 OK + ãƒ‡ãƒ¼ã‚¿
return ResponseEntity.noContent().build();  // 204 No Contentï¼ˆå‰Šé™¤æ™‚ï¼‰

// ä½œæˆæ™‚ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
return ResponseEntity.status(HttpStatus.CREATED).body(entity); // 201 Created
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè£…æ¨™æº–

### Serviceå±¤ãƒ†ã‚¹ãƒˆ
```java
@ExtendWith(MockitoExtension.class)
class EntityServiceTest {
    
    @Mock
    private EntityRepository repository;
    
    @InjectMocks
    private EntityService service;
    
    // CRUDå…¨æ“ä½œã®ãƒ†ã‚¹ãƒˆã‚’å«ã‚ã‚‹
    @Test
    void createEntity_æˆåŠŸ()
    @Test
    void getAllEntities_æˆåŠŸ()
    @Test
    void getEntityById_æˆåŠŸ()
    @Test
    void getEntityById_å­˜åœ¨ã—ãªã„å ´åˆä¾‹å¤–()
    @Test
    void updateEntity_æˆåŠŸ()
    @Test
    void updateEntity_å­˜åœ¨ã—ãªã„å ´åˆä¾‹å¤–()
    @Test
    void updateEntity_ãƒãƒ¼ã‚¸ãƒ§ãƒ³é•ã„ã§æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ä¾‹å¤–() // æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ
    @Test
    void deleteEntity_æˆåŠŸ()
    @Test
    void deleteEntity_å­˜åœ¨ã—ãªã„å ´åˆä¾‹å¤–()
}
```

**æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ã®ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š**
```java
@Test
void updateEntity_ãƒãƒ¼ã‚¸ãƒ§ãƒ³é•ã„ã§æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ä¾‹å¤–() {
    // Given
    Long entityId = 1L;
    UpdateEntityRequest request = createValidUpdateRequest();
    request.setVersion(1L); // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

    Entity existingEntity = new Entity();
    existingEntity.setId(entityId);
    existingEntity.setVersion(2L); // ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹
    when(repository.findById(entityId)).thenReturn(Optional.of(existingEntity));
    
    // Spring Data JPAã®OptimisticLockingFailureExceptionã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    when(repository.save(any(Entity.class)))
            .thenThrow(new OptimisticLockingFailureException("Version mismatch"));

    // When & Then
    assertThatThrownBy(() -> service.updateEntity(entityId, request))
            .isInstanceOf(OptimisticLockingFailureException.class);

    verify(repository).findById(entityId);
    verify(repository).save(any(Entity.class));
}
```

### Controllerå±¤ãƒ†ã‚¹ãƒˆ
```java
@WebMvcTest(EntityController.class)
class EntityControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private EntityService service;
    
    // å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã‚’å«ã‚ã‚‹
    @Test
    void createEntity_æˆåŠŸ()
    @Test
    void getAllEntities_æˆåŠŸ()
    @Test
    void getEntityById_æˆåŠŸ()
    @Test
    void updateEntity_æˆåŠŸ()
    @Test
    void deleteEntity_æˆåŠŸ()
}
```

### ãƒ¢ãƒƒã‚¯è¨­å®šã®æ³¨æ„ç‚¹
```java
// âŒ é–“é•ã„ï¼šã‚µãƒ¼ãƒ“ã‚¹ãŒexistsById()ã‚’å‘¼ã¶ã®ã«findById()ã‚’ãƒ¢ãƒƒã‚¯
when(repository.findById(1L)).thenReturn(Optional.empty());

// âœ… æ­£è§£ï¼šå®Ÿéš›ã®ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…ã«åˆã‚ã›ã¦ãƒ¢ãƒƒã‚¯
when(repository.existsById(1L)).thenReturn(false);
```

## ğŸ“¦ Repositoryå±¤å®Ÿè£…æ¨™æº–

### åŸºæœ¬å®Ÿè£…
```java
@Repository
public interface EntityRepository extends JpaRepository<Entity, Long> {
    // ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰ã‚’å¿…è¦ã«å¿œã˜ã¦å®šç¾©
    List<Entity> findByStatus(EntityStatus status);
    
    @Query("SELECT e FROM Entity e WHERE e.name LIKE %:keyword%")
    Page<Entity> findByNameContaining(@Param("keyword") String keyword, Pageable pageable);
}
```

## âœ… æ–°ã—ã„Bounded Contextä½œæˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä½œæˆ
- [ ] `created_at`, `updated_at` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
- [ ] `@PrePersist`, `@PreUpdate` ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
- [ ] é›†ç´„ãƒ«ãƒ¼ãƒˆã«ã¯ `@Version` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
- [ ] é©åˆ‡ãª `@Table` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š

### Serviceå±¤ä½œæˆ
- [ ] å…¨CRUDæ“ä½œãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- [ ] ãƒšãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- [ ] `ResourceNotFoundException` ä½¿ç”¨
- [ ] é©åˆ‡ãª `@Transactional` è¨­å®š

### Controllerå±¤ä½œæˆ
- [ ] RESTful ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
- [ ] ãƒ¡ã‚¤ãƒ³GETã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ãƒšãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œ
- [ ] try-catch é™¤å»ï¼ˆGlobalExceptionHandlerã«å§”è­²ï¼‰
- [ ] é©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¿”å´

### ãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] Serviceå±¤ã®å…¨CRUDæ“ä½œãƒ†ã‚¹ãƒˆ
- [ ] Controllerå±¤ã®å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
- [ ] ä¾‹å¤–ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
- [ ] ãƒ¢ãƒƒã‚¯è¨­å®šã®æ•´åˆæ€§ç¢ºèª

### Repositoryå±¤ä½œæˆ
- [ ] `JpaRepository` ç¶™æ‰¿
- [ ] å¿…è¦ãªã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªå®Ÿè£…

## ğŸ”§ æ—¢å­˜å®Ÿè£…ã®ä¿®æ­£æŒ‡é‡

### å„ªå…ˆåº¦ High
1. **ä¾‹å¤–å‡¦ç†ã®çµ±ä¸€** - `RuntimeException` â†’ `ResourceNotFoundException`
2. **Controller try-catché™¤å»** - GlobalExceptionHandlerã«å§”è­²
3. **ç›£æŸ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ** - `created_at`, `updated_at`

### å„ªå…ˆåº¦ Medium
4. **ãƒšãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œ** - å…¨GETæ“ä½œã«ãƒšãƒ¼ã‚¸ãƒ³ã‚°ç‰ˆè¿½åŠ 
5. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰** - é›†ç´„ãƒ«ãƒ¼ãƒˆã«æ¥½è¦³çš„ãƒ­ãƒƒã‚¯è¿½åŠ 
6. **ãƒ†ã‚¹ãƒˆå……å®Ÿ** - ä¸è¶³ã—ã¦ã„ã‚‹CRUDæ“ä½œãƒ†ã‚¹ãƒˆè¿½åŠ 

### å„ªå…ˆåº¦ Low
7. **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµ±ä¸€** - RESTfulåŸå‰‡ã«æº–æ‹ 
8. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™** - APIä»•æ§˜æ›¸æ›´æ–°

## ğŸ¨ å‘½åè¦å‰‡

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹é€ 
```
com.example.syndicatelending
â”œâ”€â”€ {boundedcontext}           # facility, party, syndicate ãªã©
â”‚   â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ repository/
â”‚   â”œâ”€â”€ entity/
â”‚   â”œâ”€â”€ dto/
â”‚   â””â”€â”€ domain/               # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼
â””â”€â”€ common/                   # å…±é€šæ©Ÿèƒ½
    â”œâ”€â”€ application/
    â”‚   â””â”€â”€ exception/
    â”œâ”€â”€ domain/
    â””â”€â”€ infrastructure/
```

### ã‚¯ãƒ©ã‚¹å‘½å
- **Entity**: `Facility`, `Company` ãªã©ï¼ˆå˜æ•°å½¢ï¼‰
- **Service**: `FacilityService`, `PartyService` ãªã©
- **Controller**: `FacilityController`, `PartyController` ãªã©
- **Repository**: `FacilityRepository`, `CompanyRepository` ãªã©
- **DTO**: `CreateFacilityRequest`, `UpdateCompanyRequest` ãªã©

## ğŸ“š å‚è€ƒå®Ÿè£…

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ **Facilityãƒ‰ãƒ¡ã‚¤ãƒ³** ãŒå®Ÿè£…æ¨™æº–ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã¨ãªã‚Šã¾ã™ã€‚
æ–°ã—ã„Bounded Contextã‚’ä½œæˆã™ã‚‹éš›ã¯ã€Facilityã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

---

**æ›´æ–°å±¥æ­´**
- 2025-06-03: åˆç‰ˆä½œæˆï¼ˆå®Ÿè£…ä¸€è²«æ€§å‘ä¸Šã®ãŸã‚ï¼‰
